# HOWTO generate personal token on codeberg:
#   1. Personal settings -> Applications -> Generate new token
#   2. Grant access to repo read/write
#
# HOWTO on gitlab:
# Repo Settings ->
#   Repository ->
#     Protected Branches ->
#       Unprotect master (or whichever) branch
#
# TODO on github:
# Store all necessary variables as secrets, including passwords with secret
# names as specified below:
# - UNAME, EMAIL for git config
# - CODEBERG for codeberg.org token
# - GITLAB for gitlab.com token
# - SOURCEHUT_SSH_KEY for sourcehut.sr.ht SSH private key

name: push-to-elsewhere

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    # will only push *from* main
    if: ${{ github.ref == 'refs/heads/main' }}

    steps:
    - uses: actions/checkout@v4

    - name: Git setup
      run: |
          git config --global user.name "ropensci"
          git config --global user.email "noreply@ropensci.org"
          git clone https://github.com/ropensci/osmdata
          git fetch --unshallow origin
          git remote add codeberg https://${{secrets.UNAME}}:${{secrets.CODEBERG}}@codeberg.org/ropensci/osmdata.git
          git push --tags codeberg main
          git remote add gitlab https://${{secrets.UNAME}}:${{secrets.GITLAB}}@gitlab.com/ropensci/osmdata.git
          git push --tags gitlab main

    - name: Setup SSH and push to SourceHut
      run: |
          mkdir -p ~/.ssh
          ssh-keyscan -t rsa git.sr.ht >> ~/.ssh/known_hosts
          echo "${{ secrets.SOURCEHUT_SSH_KEY }}" > ~/.ssh/id_sourcehut
          chmod 600 ~/.ssh/id_sourcehut

          # Create SSH config to force using this key
          cat > ~/.ssh/config << EOF
          Host git.sr.ht
            IdentityFile ~/.ssh/id_sourcehut
            IdentitiesOnly yes
            StrictHostKeyChecking no
          EOF

          # Use GIT_SSH_COMMAND to ensure the right key is used
          export GIT_SSH_COMMAND="ssh -i ~/.ssh/id_sourcehut -o IdentitiesOnly=yes"

          git remote add sourcehut git@git.sr.ht:~mpadge/osmdata
          git push --tags sourcehut main
